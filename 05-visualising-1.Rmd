# Visualising spatial data part 1: tmap and mapview {#visualising1}

## Overall goal of the chapter
In the previous section we explored different types of spatial data and looked at how these can be used to create a map. In this section we will use `tmap` and `mapview` packages to crate both static and interactive maps. In particular, we will focus on the goals presented below.

<style>
div.green { background-color:#e3ffd9; border-radius: 5px; padding: 20px;}
</style>
<div class = "green">
### Learning objectives {-}

- Create static and interactive maps using different packages
- Learn function structure to build more advanced maps
- Analyse the differences between used packages and identify their applicability for various purposes

</div>


This chapter requires the following packages (some of them we used already):

```{r, eval=FALSE}
cran_packages_to_install <- c(
  "mapview",           # map-making package for interactive maps
  "tmap",              # map-making package for static and interactive maps
  "tidyverse",         # metapackage containing dplyr, ggplot2 and other packages
  "sf",                # package for working with spatial data
  "rnaturalearth",     # data package
  "rnaturalearthdata", # data package
  "tmaptools"          # map building package
  )
install.packages(cran_packages_to_install)
```

Next, we need to load the packages:

```{r, results='hide', warning=FALSE, message=FALSE}
library(tmap)
library(mapview)
library(ggplot2)
library(sf)
library(afrilearndata)
library(rnaturalearth)
library(rnaturalearthdata)
library(dplyr)
library(tmaptools)
```

## Quick interactive maps with mapview
`Mapview package` allows quickly and easily create interactive maps of spatial data. Therefore, it is useful when we want to quickly explore the data visually without excessive care about the quality of the presentation. However, if we need static maps or interactive maps which are more elaborate we might want to consider other options such as `tmap package` which will be presented later in this chapter.<br/>

The typical spatial objects types supported by `mapview` package are: 

- sf
- raster
- sp


```{r, warning=FALSE, message=FALSE}
# data(africountries)
# mapview(africountries)
```

## Static maps with tmap
In this section we explore the potential of `tmap` in creating static maps, which is a flexible, yet user-friendly package. Its syntax is similar to `ggplot2` (plot-making package), where additional features of the map are simply build up on top of the basic structure. Before we plot the first maps we need to create a dataset called *africa* and activate static map viewing mode.
```{r, message=FALSE}
africa <- ne_countries(continent = 'africa', scale = "medium", returnclass = "sf")

tmap_mode("plot") #activates static map viewing mode
```
Next, we create an empty contour map of the continent, where `tm_shape()` function serves as a basic component containing the shape object i.e. our spatial dataset. On top of this basic element we can then add more layers using `+` operator. The advantage of `tmap` package is that it offers a large variety layers and these are named relatively intuitively to make the search and use easier. For example, we will now use layer called `tm_borders()` which defines the borders of the polygons. 
```{r, results='hide', out.width="75%"}
tm_shape(africa)+
 tm_borders()
```

Further, we create an empty, borderless map using `tm_fill()` which defines the fill of the polygons. 
```{r, out.width="75%"}
tm_shape(africa)+
 tm_fill()
```

Intuitively to create a map with both layers, we need to include `tm_fill()` and `tm_borders()` simultaneously. Alternatively, `tm_polygons()` function allows us to achieve exactly the same result more efficiently. It draws the polygons borders and fills them.
```{r,fig.show="hold", out.width="40%"}
tm_shape(africa)+ 
 tm_borders()+
  tm_fill()
tm_shape(africa)+
 tm_polygons()

```

We can further develop our map by adjusting different features of the map such as colour and transparency of the map, width and types of the border lines etc. The extra parameters for changing the plot elements can be found [here](http://publish.illinois.edu/johnrgallagher/files/2015/10/BaseGraphicsCheatsheet.pdf).

```{r, out.width="75%"}
tm_shape(africa)+
 tm_polygons(col = "green", lty = "dotted", alpha = 0.3)
```

As we already know a basic structure required to build a static map, we can proceed to a more advanced (and useful) example, where we fill the polygons using data on *last census* and adding relevant title to the legend. In this case, we also use `legend.format`option to format the legend numbers to be treated as years.

```{r, warning=FALSE, out.width="75%"}
tm_shape(africa)+
 tm_polygons(col = "lastcensus", title = "Year of last census", legend.format = list(format="s"))
```

Further, we can build on the previous map by adding labels for country names with `tm_text` function.

```{r, warning=FALSE, out.width="75%"}
tm_shape(africa)+
 tm_polygons(col = "lastcensus", title = "Year of last census", legend.format = list(format="s"))+
 tm_text("admin", size = 0.52, fontface = "bold", auto.placement = TRUE)
```

Another useful function in `tmap` is the adjustment of the intervals in the legend, in case the default scale does not provide enough variety. For example, plotting the population of African countries on the map using default intervals (stemming from the data) is not very informative due to to much clustering of information. Instead, we might want to use `breaks` argument to set them up manually to provide more differentiation visually. For clarity, I set up the customised breaks outside of the map-making function. Alternatively, we can control number of so-called `bins` (groups) into which the *Population* is divided, by setting `n` argument to a desired number of bins inside the `tm_polygons` function.

```{r, warning=FALSE, fig.show="hold", fig.cap = "Africa's population with default breaks (left), customised breaks (middle) and divided in bins (right).", out.width="33%"}
#default settings
tm_shape(africa)+                                
 tm_polygons(col = "pop_est", title = "Population")

#set up breaks manually
custom_breaks = c(10, 40, 80, 120, 160, 200, 240, 280, 320) * 100000
tm_shape(africa)+                               
 tm_polygons(col = "pop_est", title = "Population", breaks = custom_breaks)

#set up a number of bins
tm_shape(africa)+                                
 tm_polygons(col = "pop_est", title = "Population", n = 15)
```


### Colour pallet
An important aspect of the maps, as in every visual representation, are the colours. In `tmap` we can change the default colours using `palette` argument. 
```{r, warning=FALSE, results='hide', out.width="75%"}
tm_shape(africa)+
 tm_polygons(col = "lastcensus", title = "Year of last census", palette = "Set1", legend.format = list(format="s"))

```

In the example above we used palette called *Set1*. To view possible options, run `tmaptools::palette_explorer()` which will open a new window with a wide range of palettes. Sliders on the left hand side allow selecting a number of colours.

### Different layers for the static maps
`tmap` not only allows us to add extra layers to a single map by building on a basic structure, but it also enables us to join maps from different datasets. We first create an object called *countries* which is a single map with African countries:
```{r, warning=FALSE, out.width="75%"}
data(africountries)
countries = tm_shape(africountries)+  
  tm_polygons(col = "lightblue")
countries #view object "countries"
```

Then we use it as an argument to merge it with a map containing the location of capitals.
```{r, warning=FALSE, out.width="75%"}
data(africapitals)
countries+
  tm_shape(africapitals)+  #uses dataset with capitals
  tm_dots(size = 0.15)       #adds dots on the map
```

### Exercises
The solution to the exercises are provided at the [end of the chapter](#solutions_ch5).

<style>
div.purple { background-color:#e9d0f7; border-radius: 5px; padding: 20px;}
</style>
<div class = "purple">
**Exercise 1**: Change the settings to obtain a yellow, non-transparent map with solid line borders of width 3, as showed below. 
</div>   



<style>
div.purple { background-color:#e9d0f7; border-radius: 5px; padding: 20px;}
</style>
<div class = "purple">
**Exercise 2**: Create a blue map with transparency of 0.3, dotted, non-transparent, red borders, as demonstrated below.
</div>  



<style>
div.purple { background-color:#e9d0f7; border-radius: 5px; padding: 20px;}
</style>
<div class = "purple">
**Exercise 3**: Create a map with polygons filled with gross domestic product, black borders, legend titled *GDP* and customised breaks at 0, 20000, 30000, 40000, 50000, 100000, 200000, 300000, 500000.
</div>  

## Interactive maps with tmap
`tmap`package offers versatility not only for creating static maps, as we have seen above, but it also allows for making customised interactive maps conveniently by simply changing the mode of operation from static *plot* to dynamic *view* using `tmap_mode()`. After the activation of an interactive mode all the maps produced with `tmap` will be interactive. Therefore, we are able to create all the maps that we have produced so far in an interactive version.  
```{r, warning=FALSE}
tmap_mode("view")
tm_shape(africa)+  
tm_polygons()
```


To return to static maps mode, we need to set the `tmap_mode` back to `plot`. As we can see, regradless of the mode, the creation of maps using `tmap` package is easy and convenient. The only additional faeture in the dynamic (interactive mode) is the choice of the background map. This can be set up using function `tm_basemap`.

## Further resources

## Exercise solutions {#solutions_ch5}
```{r, include = FALSE}
tmap_mode("plot")
```

- Exercise 1
```{r, out.width="60%"}
tm_shape(africa)+
 tm_polygons(col = "yellow", lwd = 3, lty = "solid", alpha = 1)
```

- Exercise 2
```{r, out.width="60%"}
tm_shape(africa)+
 tm_fill(col = "blue",alpha = 0.3)+
 tm_borders(col = "red", lty = "dotted", alpha = 1)
```


- Exercise 3
```{r, out.width="60%"}
custom_breaks = c(0, 2, 3, 4, 5, 10,20, 30, 50) * 10000
tm_shape(africa)+
 tm_polygons(col = "gdp_md_est", title = "GDP",  breaks = custom_breaks)
```
