# Visualising spatial data part 1: tmap and mapview {#visualising1}

## Overall goal of the chapter
In the previous section we explored different types of spatial data and looked at how these can be used to create a map. In this section we will use `tmap` and `mapview` packages to crate both static and interactive maps. In particular, we will focus on the goals presented below.

<style>
div.green { background-color:#e3ffd9; border-radius: 5px; padding: 20px;}
</style>
<div class = "green">
### Learning objectives {-}

- Create static and interactive maps using different packages
- Learn function structure to build more advanced maps
- Analyse the differences between used packages and identify their applicability for various purposes

</div>


This chapter requires the following packages (some of them we used already):

```{r, eval=FALSE}
cran_packages_to_install <- c(
  "mapview",            # map-making package for interactive maps
  "tmap",               # map-making package for static and interactive maps
  "tidyverse",         # metapackage containing dplyr, ggplot2 and other packages
  "sf",                # package for working with spatial data
  "rnaturalearth",     # data package
  "rnaturalearthdata",  # data package
  "tmaptools"              # map building package
  )
install.packages(cran_packages_to_install)
```

Next, we need to load the packages:

```{r, results='hide', warning=FALSE, message=FALSE}
library(tmap)
library(mapview)
library(ggplot2)
library(sf)
library(afrilearndata)
library(rnaturalearth)
library(rnaturalearthdata)
library(dplyr)
library(tmaptools)
```

## Quick interactive maps with mapview
`Mapview package` allows quickly and easily create interactive maps of spatial data. Therefore, it is useful when we want to quickly explore the data visually without excessive care about the quality of the presentation. However, if we need static maps or interactive maps which are more elaborate we might want to consider other options such as `tmap package` which will be presented later in this chapter.<br/>

The typical spatial objects types supported by `mapview` package are: 

- sf
- raster
- sp


```{r, warning=FALSE, message=FALSE}
# data(africountries)
# mapview(africountries)
```

## Static maps with tmap
In this section we will explore the possibilities of `tmap` in creating static maps, which is a flexible, yet user-friendly package. Its syntax is similar to `ggplot2` (plot-making package), where additional features of the map are simply build up on top of the basic structure. It will be demonstrated below, where we will start off with a simple contour map.

Create a dataset:
```{r}
africa <- ne_countries(continent = 'africa', scale = "medium", returnclass = "sf")
```
Create an empty contour map of the continent, where `tm_shape()` function contains shape object (our spatial dataset) and `tm_borders()` defines the borders of the polygons. 
```{r, results='hide'}
tmap_mode("plot") #activates static map viewing mode
tm_shape(africa)+
 tm_borders()
```

You can also create an empty shape map using `tm_fill()` which defines the fill of the polygons. 
```{r}
tm_shape(africa)+
 tm_fill()
```

You can also create a map with both these features in one go using `tm_polygons()` function:
```{r}
tm_shape(africa)+
 tm_polygons()
```

We can further develop our map by adjusting different features of the map such as colour and transparency of the map, width and types of the border lines etc. The extra parameters for changing the plot elements can be found [here](http://publish.illinois.edu/johnrgallagher/files/2015/10/BaseGraphicsCheatsheet.pdf).

```{r}
tm_shape(africa)+
 tm_polygons(col = "green", lty = "dotted", alpha = 0.3)
```

- **Exercise 1**: Change the settings to the map to obtain yellow, non-transparent map with solid line borders of width 3, as showed below. (The solution to the exercises are provided at the end of the chapter [click here](#solutions_ch5))

```{r, echo=FALSE}
tm_shape(africa)+
 tm_polygons(col = "yellow", lwd = 3, lty = "solid", alpha = 1)
```

- **Exercise 2**: create a blue map with transparency of 0.3, dotted, non-transparent, red borders, such as one below:   
```{r, echo=FALSE}
tm_shape(africa)+
 tm_fill(col="blue",alpha = 0.3)+
 tm_borders(col = "red", lty = "dotted", alpha = 1)

```



As we already know a basic structure required to build a static map, we can proceed to a more advanced (and useful) example where we fill the polygons using data on last census, add relevant title to the legend. In this case, we also use `legend.format`option to format the legend numbers to be treated as years.

```{r, warning=FALSE}
tm_shape(africa)+
 tm_fill(col="lastcensus", title="Year of last census", legend.format = list(format="s"))+
 tm_borders()

```

We build on the previous map by adding labels for country names with `tm_text` function.

```{r, warning=FALSE}
tm_shape(africa)+
 tm_fill(col="lastcensus", title="Year of last census", legend.format = list(format="s"))+
 tm_borders()+
 tm_text("admin", size = 0.52,  fontface="bold", auto.placement = TRUE)

```

Another useful function in `tmap` is adjusting the intervals of the legend, in case the default scale does not provide enough variety. For example, when we try to see the populations of African countries on the map using default intervals stemming from the data we see:
```{r, warning=FALSE}
tm_shape(africa)+
 tm_fill(col="pop_est", title="Population")+
 tm_borders()
```

Instead, we might want to use `breaks` argument to set them up manually to provide more differentiation visually. 
```{r, warning=FALSE}
tm_shape(africa)+
 tm_fill(col="pop_est", title="Population", breaks = c(1000000, 4000000, 8000000, 12000000, 16000000, 20000000, 24000000, 28000000,32000000))+
 tm_borders()
```

- **Exercise 3**: create a map with polygons filled with gross domestic product, black borders, legend titled *GDP* and customised breaks at 0, 20000, 30000, 40000, 50000, 100000, 200000, 300000, 500000, such as seen below.
```{r, echo=FALSE}
tm_shape(africa)+
 tm_fill(col="gdp_md_est", title="GDP", breaks = c(0, 20000, 30000, 40000, 50000, 100000,200000, 300000, 500000))+
 tm_borders()
```

### Colour pallet
An important aspect of the maps, as in every visual representation, are the colours. In `tmap` we can change the default colours using `palette` argument. 
```{r, warning=FALSE, results='hide'}
tm_shape(africa)+
 tm_fill(col="lastcensus", title="Year of last census", palette = "Set1", legend.format = list(format="s"))+
 tm_borders()

```

In the example above we used palette called *Set1*. To view possible options, run `tmaptools::palette_explorer()` which will open a new window with a wide range of palettes. Sliders on the left hand side allow selecting a number of colours.

### Layers for the static maps
`tmap` not only allows us to add extra layers to a single map by building on a basic structure, but it also enables us to join maps from different datasets. We first create an object called *countries* which is a single map with African countries:
```{r, warning=FALSE}
data(africountries)

countries = tm_shape(africountries)+  
  tm_polygons(col="lightblue")
```

Then we use it as an argument to merge it with a map containing the location of capitals.
```{r, warning=FALSE}
data(africapitals)

countries+
  tm_shape(africapitals)+  #uses dataset with capitals
  tm_dots(size=0.15)       #adds dots on the map
```



## Interactive maps with tmap

`tmap` offers versatility not only for creating static maps as we have seen above but it also allows us to make customised interactive maps conveniently by simply changing the mode of operation from static *plot* to dynamic *view* using `tmap_mode()`

```{r, warning=FALSE}
# tmap_mode("view") #switches to interactive mode
# tm_shape(africa)+  #creates a map from previous chapter in an interactive mode
#   tm_borders()

```


## Further resources

## Exercise solutions {#solutions_ch5}

- Exercise 1
```{r, results='hide', fig.show='hide'}
tm_shape(africa)+
 tm_polygons(col = "yellow", lwd = 3, lty = "solid", alpha = 1)
```

- Exercise 2
```{r, results='hide', fig.show='hide'}
tm_shape(africa)+
 tm_fill(col="blue",alpha = 0.3)+
 tm_borders(col = "red", lty = "dotted", alpha = 1)
```

- Exercise 3
```{r, results='hide', fig.show='hide'}
tm_shape(africa)+
 tm_fill(col="gdp_md_est", title="GDP",  breaks = c(0, 20000, 30000, 40000, 50000, 100000,200000, 300000, 500000))+
 tm_borders()
```
